

/*

exec RSP_SALES_REPORT_LIST '05/18/2018','01/18/2019',1,'','','','','','','','',''

*/


ALTER proc [dbo].[RSP_SALES_REPORT_LIST]
@FROM_DATE datetime,
@TO_DATE datetime,
@COMPANY_ID varchar(10),
@BRANCH_ID NVARCHAR(10),
@MAKE_BY NVARCHAR(10),
@PRODUCT_CODE NVARCHAR(50),
@CATEGORY_ID NVARCHAR(10),
@SUBCATEGORY_ID NVARCHAR(10),
@BRAND_ID NVARCHAR(10),
@USER_NAME NVARCHAR(10),
@BUYER_SUPPLIER_ID NVARCHAR(10),
@VOUCHER_NO NVARCHAR(29),
@ACCOUNTS_CODE NVARCHAR(50)
AS
set nocount on




declare @total_return decimal(18,2)
declare @total_return_only decimal(18,2)

set  @total_return =
(
select SUM (TOTAL_RETURN_AMOUNT) from SALES_RETURN

where  (CAST(CONVERT(varchar,MAKE_DT, 106) AS datetime) BETWEEN 
(CAST(CONVERT(varchar,@FROM_DATE, 106) AS datetime)) AND 
(CAST(CONVERT(varchar,@TO_DATE, 106) AS datetime))) AND
REMARKS='Exchange Product'  and
CANCEL_FLAG=0 
)



set  @total_return_only =
(
select SUM (TOTAL_RETURN_AMOUNT) from SALES_RETURN

where  (CAST(CONVERT(varchar,MAKE_DT, 106) AS datetime) BETWEEN 
(CAST(CONVERT(varchar,@FROM_DATE, 106) AS datetime)) AND 
(CAST(CONVERT(varchar,@TO_DATE, 106) AS datetime))) AND
REMARKS='Sales Return'  and
CANCEL_FLAG=0 
)











declare @total_sum decimal(18,2)



select @total_sum=SUM(a)
from
(
SELECT distinct s.SALES_INVOICE_NO,((s.TOTAL_AMOUNT+s.TOTAL_VAT)-s.TOTAL_DISCOUNT) a
FROM         COMPANY c INNER JOIN
                      SALES s 
                       ON c.COMPANY_ID = s.COMPANY_ID
                      INNER JOIN
                      SALES_DETAILS sd ON s.SALES_INVOICE_NO = sd.SALES_INVOICE_NO
                     and s.COMPANY_ID=sd.COMPANY_ID
                       --ON COMPANY.COMPANY_ID = s.COMPANY_ID 
                       INNER JOIN
                      PRODUCT p ON sd.PRODUCT_CODE = p.PRODUCT_CODE 
                      and sd.COMPANY_ID=p.COMPANY_ID AND SD.BRANCH_ID=P.BRANCH_ID
                      INNER JOIN
                      PRODUCT_BRAND pb ON p.BRAND_ID = pb.BRAND_ID INNER JOIN
                      PRODUCT_UNIT_TYPES put ON sd.UNIT_ID = put.UNIT_ID
                      and sd.COMPANY_ID=put.COMPANY_ID
						INNER JOIN BUYER_SUPPLIER_INFO bs
						ON s.BUYER_SUPPLIER_ID=bs.BUYER_SUPPLIER_ID
						and s.COMPANY_ID=bs.COMPANY_ID
where  (CAST(CONVERT(varchar,s.MAKE_DT, 106) AS datetime) BETWEEN 
(CAST(CONVERT(varchar,@FROM_DATE, 106) AS datetime)) AND 
(CAST(CONVERT(varchar,@TO_DATE, 106) AS datetime))) AND
CANCEL_FLAG=0 
--and RETURN_FLAG=0
and s.COMPANY_ID=@COMPANY_ID
--and s.BRANCH_ID=@BRANCH_ID
--AND S.MAKE_BY=@MAKE_BY
and
((p.PRODUCT_CODE=@PRODUCT_CODE and p.COMPANY_ID=@COMPANY_ID) OR (@PRODUCT_CODE='' and p.COMPANY_ID=@COMPANY_ID))
AND ((p.CATEGORY_ID=@CATEGORY_ID and P.COMPANY_ID=@COMPANY_ID) OR (@CATEGORY_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((P.SUBCATEGORY_ID=@SUBCATEGORY_ID and P.COMPANY_ID=@COMPANY_ID) OR (@SUBCATEGORY_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((P.BRAND_ID=@BRAND_ID and P.COMPANY_ID=@COMPANY_ID) OR (@BRAND_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((s.BRANCH_ID=@BRANCH_ID and s.COMPANY_ID=@COMPANY_ID) OR (@BRANCH_ID='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.MAKE_BY=@USER_NAME and s.COMPANY_ID=@COMPANY_ID) OR (@USER_NAME='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.BUYER_SUPPLIER_ID=@BUYER_SUPPLIER_ID and s.COMPANY_ID=@COMPANY_ID) OR (@BUYER_SUPPLIER_ID='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.EMI_FLAG=@VOUCHER_NO and s.COMPANY_ID=@COMPANY_ID) OR (@VOUCHER_NO='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.MAKE_BY=@USER_NAME and s.COMPANY_ID=@COMPANY_ID) OR (@USER_NAME='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.COLLECTED_ACCOUNT_ID=@ACCOUNTS_CODE and s.COMPANY_ID=@COMPANY_ID) OR (@ACCOUNTS_CODE='' and s.COMPANY_ID=@COMPANY_ID))


--group by s.SALES_INVOICE_NO
)aa







declare @total_net_discount decimal(18,2)



select @total_net_discount=SUM(b)
from
(
SELECT distinct s.SALES_INVOICE_NO,(TOTAL_DISCOUNT) b
FROM         COMPANY c INNER JOIN
                      SALES s 
                       ON c.COMPANY_ID = s.COMPANY_ID
                      INNER JOIN
                      SALES_DETAILS sd ON s.SALES_INVOICE_NO = sd.SALES_INVOICE_NO
                     and s.COMPANY_ID=sd.COMPANY_ID
                       --ON COMPANY.COMPANY_ID = s.COMPANY_ID 
                       INNER JOIN
                      PRODUCT p ON sd.PRODUCT_CODE = p.PRODUCT_CODE 
                      and sd.COMPANY_ID=p.COMPANY_ID AND SD.BRANCH_ID=P.BRANCH_ID
                      INNER JOIN
                      PRODUCT_BRAND pb ON p.BRAND_ID = pb.BRAND_ID INNER JOIN
                      PRODUCT_UNIT_TYPES put ON sd.UNIT_ID = put.UNIT_ID
                      and sd.COMPANY_ID=put.COMPANY_ID
						INNER JOIN BUYER_SUPPLIER_INFO bs
						ON s.BUYER_SUPPLIER_ID=bs.BUYER_SUPPLIER_ID
						and s.COMPANY_ID=bs.COMPANY_ID
where  (CAST(CONVERT(varchar,s.MAKE_DT, 106) AS datetime) BETWEEN 
(CAST(CONVERT(varchar,@FROM_DATE, 106) AS datetime)) AND 
(CAST(CONVERT(varchar,@TO_DATE, 106) AS datetime))) AND
CANCEL_FLAG=0 
--and RETURN_FLAG=0
and s.COMPANY_ID=@COMPANY_ID
--and s.BRANCH_ID=@BRANCH_ID
--AND S.MAKE_BY=@MAKE_BY
and
((p.PRODUCT_CODE=@PRODUCT_CODE and p.COMPANY_ID=@COMPANY_ID) OR (@PRODUCT_CODE='' and p.COMPANY_ID=@COMPANY_ID))
AND ((p.CATEGORY_ID=@CATEGORY_ID and P.COMPANY_ID=@COMPANY_ID) OR (@CATEGORY_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((P.SUBCATEGORY_ID=@SUBCATEGORY_ID and P.COMPANY_ID=@COMPANY_ID) OR (@SUBCATEGORY_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((P.BRAND_ID=@BRAND_ID and P.COMPANY_ID=@COMPANY_ID) OR (@BRAND_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((s.BRANCH_ID=@BRANCH_ID and s.COMPANY_ID=@COMPANY_ID) OR (@BRANCH_ID='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.MAKE_BY=@USER_NAME and s.COMPANY_ID=@COMPANY_ID) OR (@USER_NAME='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.BUYER_SUPPLIER_ID=@BUYER_SUPPLIER_ID and s.COMPANY_ID=@COMPANY_ID) OR (@BUYER_SUPPLIER_ID='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.EMI_FLAG=@VOUCHER_NO and s.COMPANY_ID=@COMPANY_ID) OR (@VOUCHER_NO='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.MAKE_BY=@USER_NAME and s.COMPANY_ID=@COMPANY_ID) OR (@USER_NAME='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.COLLECTED_ACCOUNT_ID=@ACCOUNTS_CODE and s.COMPANY_ID=@COMPANY_ID) OR (@ACCOUNTS_CODE='' and s.COMPANY_ID=@COMPANY_ID))


--group by s.SALES_INVOICE_NO
)bb





SELECT   distinct  s.SALES_INVOICE_NO,'Mobile No:- ' +s.EMI_FLAG as FAX,
((s.TOTAL_AMOUNT+s.TOTAL_VAT)-s.TOTAL_DISCOUNT) TOTAL_AMOUNT,s.MAKE_DT,
 s.TOTAL_VAT, 
 isnull(@total_return_only,0) as PREVIOUS_DUES,
 s.TOTAL_DISCOUNT, s.COLLECTED_AMOUNT,
 --(s.TOTAL_AMOUNT + s.TOTAL_VAT- s.TOTAL_DISCOUNT)GRAND_TOTAL,
  @total_net_discount as BUYER_SUPPLIER_ID,c.COMPANY_NAME, c.ADDRESS, c.PHONE, c.EMAIL, c.URL, 
  sd.PRODUCT_CODE,
  
  case when (SD.QUANTITY<0) Then P.PRODUCT_NAME+' (Return Product)' else P.PRODUCT_NAME end PRODUCT_NAME,
sd.QUANTITY, sd.SALES_PRICE,sd.PURCHASE_PRICE SALES_VAT, SD.SALES_DISCOUNT as SALES_VAT_AMOUNT_TOTAL,
  @total_return as UNIT_ID,  put.UNIT_NAME,
   cast ( bs.BUYER_SUPPLIER_NAME as nvarchar(max))+' ('  + cast (s.REMARKS as nvarchar(max) )+')' 
   as BUYER_SUPPLIER_NAME,
                 --    bs.BUYER_SUPPLIER_NAME,
0 GIVEN_AMOUNT,0 CHANGE_AMOUNT
,@FROM_DATE COMPANY_ID,
@TO_DATE  BRAND_ID,
(@total_sum- ISNULL(@total_return, 0 ) ) GRAND_TOTAL,
dbo.GET_SERIAL_LIST_FOR_SALES(sd.PRODUCT_CODE,S.COMPANY_ID,S.SALES_INVOICE_NO) BRAND_NAME
FROM         COMPANY c INNER JOIN
                      SALES s 
                       ON c.COMPANY_ID = s.COMPANY_ID
                      INNER JOIN
                      SALES_DETAILS sd ON s.SALES_INVOICE_NO = sd.SALES_INVOICE_NO
                     and s.COMPANY_ID=sd.COMPANY_ID AND s.BRANCH_ID=sd.BRANCH_ID
                       --ON COMPANY.COMPANY_ID = s.COMPANY_ID 
                       INNER JOIN
                      PRODUCT p ON sd.PRODUCT_CODE = p.PRODUCT_CODE 
                      and sd.COMPANY_ID=p.COMPANY_ID AND SD.BRANCH_ID=P.BRANCH_ID
                      
                      INNER JOIN
                      PRODUCT_BRAND pb ON p.BRAND_ID = pb.BRAND_ID
                      and sd.COMPANY_ID=pb.COMPANY_ID 
                      
                       INNER JOIN
                      PRODUCT_UNIT_TYPES put ON sd.UNIT_ID = put.UNIT_ID
                      and sd.COMPANY_ID=put.COMPANY_ID
						INNER JOIN BUYER_SUPPLIER_INFO bs
						ON s.BUYER_SUPPLIER_ID=bs.BUYER_SUPPLIER_ID
						and s.COMPANY_ID=bs.COMPANY_ID
						and s.BRANCH_ID = bs.BRANCH_ID
where  (CAST(CONVERT(varchar,s.MAKE_DT, 106) AS datetime) BETWEEN 
(CAST(CONVERT(varchar,@FROM_DATE, 106) AS datetime)) AND 
(CAST(CONVERT(varchar,@TO_DATE, 106) AS datetime))) AND
CANCEL_FLAG=0 
--and RETURN_FLAG=0
and s.COMPANY_ID=@COMPANY_ID
--and s.BRANCH_ID=@BRANCH_ID
--AND S.MAKE_BY=@MAKE_BY
and
((p.PRODUCT_CODE=@PRODUCT_CODE and p.COMPANY_ID=@COMPANY_ID) OR (@PRODUCT_CODE='' and p.COMPANY_ID=@COMPANY_ID))
AND ((p.CATEGORY_ID=@CATEGORY_ID and P.COMPANY_ID=@COMPANY_ID) OR (@CATEGORY_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((P.SUBCATEGORY_ID=@SUBCATEGORY_ID and P.COMPANY_ID=@COMPANY_ID) OR (@SUBCATEGORY_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((P.BRAND_ID=@BRAND_ID and P.COMPANY_ID=@COMPANY_ID) OR (@BRAND_ID='' and P.COMPANY_ID=@COMPANY_ID))
AND ((s.BRANCH_ID=@BRANCH_ID and s.COMPANY_ID=@COMPANY_ID) OR (@BRANCH_ID='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.MAKE_BY=@USER_NAME and s.COMPANY_ID=@COMPANY_ID) OR (@USER_NAME='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.BUYER_SUPPLIER_ID=@BUYER_SUPPLIER_ID and s.COMPANY_ID=@COMPANY_ID) OR (@BUYER_SUPPLIER_ID='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.EMI_FLAG=@VOUCHER_NO and s.COMPANY_ID=@COMPANY_ID) OR (@VOUCHER_NO='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.MAKE_BY=@USER_NAME and s.COMPANY_ID=@COMPANY_ID) OR (@USER_NAME='' and s.COMPANY_ID=@COMPANY_ID))
AND ((s.COLLECTED_ACCOUNT_ID=@ACCOUNTS_CODE and s.COMPANY_ID=@COMPANY_ID) OR (@ACCOUNTS_CODE='' and s.COMPANY_ID=@COMPANY_ID))


order by  s.SALES_INVOICE_NO





