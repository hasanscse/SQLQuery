

ALTER PROC [dbo].[FSP_PRODUCT_SALES_DETAILS]
(
@SALES_INVOICE_NO NVARCHAR(30),
@PRODUCT_CODE NVARCHAR(20),
@UNIT_ID NVARCHAR(20),
@QUANTITY DECIMAL(18,2),  
@SALES_PRICE DECIMAL(18,2),
@SERIAL_AVAILABLE INT,
@SALES_VAT DECIMAL(18,2),
@SALES_VAT_AMOUNT_TOTAL DECIMAL(18,2),
@PURCHASE_PRICE DECIMAL(18,2),
@COMPANY_ID NVARCHAR(10),
@BRANCH_ID NVARCHAR(10),
@SALES_DISCOUNT DECIMAL(18,2)
--,
--@ITEAM_PCS DECIMAL(18,2)
)
AS

INSERT INTO SALES_DETAILS
(
SALES_INVOICE_NO,
PRODUCT_CODE,
UNIT_ID,
QUANTITY, 
SALES_PRICE,
SERIAL_AVAILABLE,
SALES_VAT,
SALES_DISCOUNT,
SALES_VAT_AMOUNT_TOTAL,
PURCHASE_PRICE,
COMPANY_ID,
BRANCH_ID
--,
--ITEAM_PCS
)
VALUES(
@SALES_INVOICE_NO,
@PRODUCT_CODE,
@UNIT_ID,
@QUANTITY, 
@SALES_PRICE,
@SERIAL_AVAILABLE,
@SALES_VAT,
@SALES_DISCOUNT,
@SALES_VAT_AMOUNT_TOTAL,
@PURCHASE_PRICE,
@COMPANY_ID,
@BRANCH_ID
--,
--@ITEAM_PCS
)

declare @total_pur decimal(18,2)
set @total_pur = (select PURCHASE_PRICE from PRODUCT where PRODUCT_CODE=@PRODUCT_CODE and COMPANY_ID=@COMPANY_ID  AND BRANCH_ID=@BRANCH_ID)


update dbo.PRODUCT
set STOCK_QUANTITY=STOCK_QUANTITY-@QUANTITY,
	TOTAL_STOCK_AMOUNT=
	case when STOCK_QUANTITY-@QUANTITY=0
	then 0
	 when STOCK_QUANTITY-@QUANTITY<0
	then TOTAL_STOCK_AMOUNT - @total_pur*@QUANTITY
	else TOTAL_STOCK_AMOUNT-(PURCHASED_PRICE*@QUANTITY) end
	,
	PURCHASED_PRICE=case when STOCK_QUANTITY-@QUANTITY<=0 then 0 
						 else (TOTAL_STOCK_AMOUNT-PURCHASED_PRICE*@QUANTITY)/(STOCK_QUANTITY-@QUANTITY) end
						 --,SALES_PRICE = @SALES_PRICE
where PRODUCT_CODE=@PRODUCT_CODE AND COMPANY_ID=@COMPANY_ID  AND BRANCH_ID=@BRANCH_ID