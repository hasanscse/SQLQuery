



ALTER proc [dbo].[FSP_SALES_QUANTITY_G_INVOICE]
@SALES_INVOICE_NO varchar (50),
@COMPANY_ID varchar(10)
AS


SELECT   d.PRODUCT_CODE, p.SALES_INVOICE_NO,
 p.BUYER_SUPPLIER_ID, p.TOTAL_AMOUNT,p.COLLECTED_AMOUNT, 
 p.COMPANY_ID, p.PREVIOUS_DUES, p.MAKE_BY, p.MAKE_DT, p.CANCELLED_DT,pro.STOCK_QUANTITY, 
  p.CANCELLED_REASON, p.REMARKS, d.SALES_DETAILS_ID, d.SALES_INVOICE_NO,d.SALES_DISCOUNT ,
  d.UNIT_ID, d.QUANTITY, d.SALES_PRICE,
   d.SERIAL_AVAILABLE,pro.PRODUCT_NAME,u.UNIT_NAME,pro.PRODUCT_DESCRIPTION ,
   pro.PRODUCT_CODE,pro.SALES_VAT,((d.QUANTITY*d.SALES_PRICE)+ISNULL(D.SALES_VAT_AMOUNT_TOTAL,0))  
   TOTAL_AMOUNT_PRODUCTWISE,d.PURCHASE_PRICE
                     

FROM         SALES p INNER JOIN
             SALES_DETAILS d ON p.SALES_INVOICE_NO = d.SALES_INVOICE_NO 
             and p.COMPANY_ID=d.COMPANY_ID and p.BRANCH_ID=d.BRANCH_ID  
            inner join PRODUCT pro on d.PRODUCT_CODE=pro.PRODUCT_CODE
            and d.COMPANY_ID=pro.COMPANY_ID and p.BRANCH_ID=pro.BRANCH_ID 
           inner join PRODUCT_UNIT_TYPES u on d.UNIT_ID=u.UNIT_ID
           and d.COMPANY_ID=u.COMPANY_ID  
           
where p.SALES_INVOICE_NO=@SALES_INVOICE_NO and p.COMPANY_ID=@COMPANY_ID
--
--SELECT   d.PRODUCT_CODE AS Expr1, p.SALES_INVOICE_NO AS Expr2, p.SUPPLIER_ID, p.TOTAL_AMOUNT,p.PAID_AMOUNT, 
--                      p.COMPANY_ID, p.PREVIOUS_DUES, p.MAKE_BY, p.MAKE_DT, p.CANCELLED_BY, p.CANCELLED_DT, 
--                      p.CANCELLED_REASON, p.REMARKS, d.SALES_DETAILS_ID, d.SALES_INVOICE_NO, 
--                      d.UNIT_ID, d.QUANTITY, d.SALESD_PRICE, d.SERIAL_AVAILABLE, 
--                      s.SALESD_PRODUCT_SERIAL_ID, s.SALES_INVOICE_NO AS Expr3, 
--                      s.PRODUCT_SERIAL, s.PRODUCT_CODE
--
--FROM         SALES p INNER JOIN
--                      SALES_DETAILS d ON p.SALES_INVOICE_NO = d.SALES_INVOICE_NO INNER JOIN
--                      SALESD_PRODUCT_SERIAL s ON d.PRODUCT_CODE = s.PRODUCT_CODE AND 
--                      p.SALES_INVOICE_NO = s.SALES_INVOICE_NO




















--------------------------------------------


USE [INVENTORY_MASTER]
GO
/****** Object:  StoredProcedure [dbo].[FSP_PRODUCT_PURCHASE_DETAILS]    Script Date: 02/03/2020 16:20:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[FSP_PRODUCT_PURCHASE_DETAILS]
@PURCHASE_INVOICE_NO NVARCHAR(30),
@PRODUCT_CODE NVARCHAR(30),
@UNIT_ID NVARCHAR(30),
@QUANTITY NVARCHAR(30),  
@TOTAL_PURCHASED_PRICE DECIMAL(18,2),
@PURCHASED_PRICE DECIMAL(18,2),
@SERIAL_AVAILABLE NVARCHAR(30),
@COMPANY_ID NVARCHAR(30),
@BRANCH_ID NVARCHAR(30),
@EXP_DATE datetime
AS

INSERT INTO PURCHASE_DETAILS
(
PURCHASE_INVOICE_NO,
PRODUCT_CODE,
UNIT_ID,
QUANTITY, 
TOTAL_PURCHASED_PRICE,
SERIAL_AVAILABLE,
COMPANY_ID,
BRANCH_ID
)
VALUES
(
@PURCHASE_INVOICE_NO,
@PRODUCT_CODE,
@UNIT_ID,
@QUANTITY, 
@TOTAL_PURCHASED_PRICE,
@SERIAL_AVAILABLE,
@COMPANY_ID,
@BRANCH_ID
)

INSERT INTO [dbo].[PURCHASE_DETAILS_COST]
       select  @PURCHASE_INVOICE_NO
           ,[PRODUCT_CODE]
           ,[PURCHASE_COST_TYPE_ID]
           ,[COST_AMOUNT]
           ,[COMPANY_ID]
           ,[BRANCH_ID]
           from PURCHASE_COST where PURCHASE_COST.PRODUCT_CODE=@PRODUCT_CODE
 
 DECLARE @TOTAL_COST DECIMAL(18,2)=0        
           
 set @TOTAL_COST =(select sum([COST_AMOUNT])
  from PURCHASE_COST where PURCHASE_COST.PRODUCT_CODE=@PRODUCT_CODE)   
   
 
UPDATE PRODUCT 
SET STOCK_QUANTITY =ISNULL(STOCK_QUANTITY,0)+@QUANTITY,
	TOTAL_STOCK_AMOUNT=
	case when STOCK_QUANTITY+@QUANTITY=0
	then 0
	else
	(ISNULL(@TOTAL_COST,0)*@QUANTITY)+ISNULL(TOTAL_STOCK_AMOUNT,0)+@TOTAL_PURCHASED_PRICE  end,--(@QUANTITY*),
	PURCHASED_PRICE=
	case when STOCK_QUANTITY+@QUANTITY=0
	then 0
	else
	((ISNULL(@TOTAL_COST,0)*@QUANTITY)+(ISNULL(TOTAL_STOCK_AMOUNT,0)+@TOTAL_PURCHASED_PRICE))/(ISNULL(STOCK_QUANTITY,0)+@QUANTITY)
	--,PURCHASE_PRICE = (@TOTAL_PURCHASED_PRICE/@QUANTITY)
	end,EXP_DATE=@EXP_DATE
WHERE PRODUCT_CODE=@PRODUCT_CODE AND BRANCH_ID=@BRANCH_ID
AND COMPANY_ID=@COMPANY_ID











-------------------------------------------------






USE [INVENTORY_MASTER]
GO
/****** Object:  StoredProcedure [dbo].[FSP_PRODUCT_SALES_DETAILS]    Script Date: 02/03/2020 16:21:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[FSP_PRODUCT_SALES_DETAILS]
(
@SALES_INVOICE_NO NVARCHAR(30),
@PRODUCT_CODE NVARCHAR(20),
@UNIT_ID NVARCHAR(20),
@QUANTITY DECIMAL(18,2),  
@SALES_PRICE DECIMAL(18,2),
@SERIAL_AVAILABLE INT,
@SALES_VAT DECIMAL(18,2),
@SALES_VAT_AMOUNT_TOTAL DECIMAL(18,2),
@PURCHASE_PRICE DECIMAL(18,2),
@COMPANY_ID NVARCHAR(10),
@BRANCH_ID NVARCHAR(10),
@SALES_DISCOUNT DECIMAL(18,2)
--,
--@ITEAM_PCS DECIMAL(18,2)
)
AS

INSERT INTO SALES_DETAILS
(
SALES_INVOICE_NO,
PRODUCT_CODE,
UNIT_ID,
QUANTITY, 
SALES_PRICE,
SERIAL_AVAILABLE,
SALES_VAT,
SALES_DISCOUNT,
SALES_VAT_AMOUNT_TOTAL,
PURCHASE_PRICE,
COMPANY_ID,
BRANCH_ID
--,
--ITEAM_PCS
)
VALUES(
@SALES_INVOICE_NO,
@PRODUCT_CODE,
@UNIT_ID,
@QUANTITY, 
@SALES_PRICE,
@SERIAL_AVAILABLE,
@SALES_VAT,
@SALES_DISCOUNT,
@SALES_VAT_AMOUNT_TOTAL,
@PURCHASE_PRICE,
@COMPANY_ID,
@BRANCH_ID
--,
--@ITEAM_PCS
)

declare @total_pur decimal(18,2)
set @total_pur = (select PURCHASE_PRICE from PRODUCT where PRODUCT_CODE=@PRODUCT_CODE and COMPANY_ID=@COMPANY_ID  AND BRANCH_ID=@BRANCH_ID)


update dbo.PRODUCT
set STOCK_QUANTITY=STOCK_QUANTITY-@QUANTITY,
	TOTAL_STOCK_AMOUNT=
	case when STOCK_QUANTITY-@QUANTITY=0
	then 0
	 when STOCK_QUANTITY-@QUANTITY<0
	then TOTAL_STOCK_AMOUNT - @total_pur*@QUANTITY
	else TOTAL_STOCK_AMOUNT-(PURCHASED_PRICE*@QUANTITY) end
	,
	PURCHASED_PRICE=case when STOCK_QUANTITY-@QUANTITY=0 then 0 
						 else (TOTAL_STOCK_AMOUNT-PURCHASED_PRICE*@QUANTITY)/(STOCK_QUANTITY-@QUANTITY) end
						 --,SALES_PRICE = @SALES_PRICE
where PRODUCT_CODE=@PRODUCT_CODE AND COMPANY_ID=@COMPANY_ID  AND BRANCH_ID=@BRANCH_ID














